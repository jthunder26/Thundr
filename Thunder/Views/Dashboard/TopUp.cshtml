<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#topUpModal">
    Open Top Up
</button>

<!-- Modal -->
<div class="modal fade" id="topUpModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Top Up</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <h2>Top Up</h2>

                <div class="container">
                    <div class="row">
                        <div class="col-md-6">
                            <form>
                                <div class="form-group">
                                    <label for="userBalance">Your Balance:</label>
                                    <input type="text" class="form-control" id="userBalance" data-bind="value: userBalance" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="itemName">Item:</label>
                                    <input type="text" class="form-control" id="itemName" value="UPS Ground" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="itemPrice">Item Price:</label>
                                    <input type="text" class="form-control" id="itemPrice" value="$40.32" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="totalCost">Total Cost:</label>
                                    <input type="number" class="form-control" id="totalCost" data-bind="value: totalCost">
                                </div>
                                <button type="button" class="btn btn-primary" data-bind="click: topUp">Top Up</button>
                            </form>
                        </div>
                    </div>
                </div>

                @section Scripts {
                    <script src="https://js.stripe.com/v3/"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-min.js"></script>
                    <script>
                        function TopUpViewModel() {
                            var self = this;

                            self.userBalance = ko.observable('0');
                            self.totalCost = ko.observable('40.32');

                            self.topUp = function () {
                                // Fetch the top-up session ID from the server
                                fetch('/Stripe/TopUp?amount=' + self.totalCost())
                                    .then(function (response) {
                                        return response.json();
                                    })
                                    .then(function (result) {
                                        var sessionId = result.sessionId;
                                        var stripe = Stripe('pk_test_12345'); // Replace with your Stripe public key

                                        // Redirect to the Stripe Checkout page
                                        stripe.redirectToCheckout({ sessionId: sessionId });
                                    })
                                    .catch(function (error) {
                                        console.error('Error:', error);
                                    });
                            };

                            // Fetch the user's balance from the server and update the userBalance observable
                            fetch('/Stripe/GetUserBalance')
                                .then(function (response) {
                                    return response.json();
                                })
                                .then(function (result) {
                                    self.userBalance(result.balance.toFixed(2));
                                })
                                .catch(function (error) {
                                    console.error('Error:', error);
                                });
                        }

                        ko.applyBindings(new TopUpViewModel());
                    </script>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Top Up Modal -->
<div id="topUpModal" class="modal">
    <div class="modal-content">
        <!-- Top Up Form -->
        <form id="payment-form">
            <div id="link-authentication-element">
                <!--Stripe.js injects the Link Authentication Element-->
            </div>
            <div id="payment-element">
                <!--Stripe.js injects the Payment Element-->
            </div>
            <button id="submit">
                <div class="spinner hidden" id="spinner"></div>
                <span id="button-text">Pay now</span>
            </button>
            <div id="payment-message" class="hidden"></div>
        </form>
    </div>
</div>
